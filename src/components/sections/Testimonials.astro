---
// Styles
import 'swiper/css'
import 'swiper/css/autoplay'
import 'swiper/css/navigation'

// Components
import TestimonialCard from "../ui/TestimonialCard.astro";
import Title from "../ui/Title.astro";

// Libs
import { useTranslations } from "../../i18n/utils";

// i18n
const { lang } = Astro.params as any;
const t = useTranslations(lang);

// Data and translations
const testimonialsKeys = [
  "rocco",
  "magaly",
  "alex",
  "naomi",
  "ana",
  "gabriel",
  "erick",
];
const testimonials = t("testimonials.quotes");
---

<section
  id="testimonials"
  class:list={[
    "container",
    "flex",
    "flex-col",
    "items-center",
    "justify-center",
    "testimonials"
  ]}
>
  <Title>
    {t("testimonials.title")}
  </Title>

  <div class:list={["w-full", "relative", "py-8"]}>
    <!-- Swiper container -->
    <div class:list={["swiper"]}>
      <div class:list={["swiper-wrapper"]}>
        {
          testimonialsKeys.map((testimonialsKey) => {
            const testimonial = testimonials[testimonialsKey];

            return (
              <div
                class:list={["swiper-slide", "h-auto", "flex", "items-stretch"]}
              >
                <div
                  class:list={[
                    "card-wrapper",
                    "flex",
                    "flex-col",
                    "items-center",
                    "justify-start",
                    "p-4",
                    "h-full",
                    "w-full",
                  ]}
                  data-aos="fade-down"
                >
                  <TestimonialCard
                    imageSrc={`/testimonials/${testimonial.name}.webp`}
                    imageAlt={`${t("general.photoAlt")} ${testimonial.name}`}
                    name={testimonial.name}
                    quote={testimonial.quote}
                  />
                </div>
              </div>
            );
          })
        }
      </div>
      
      <!-- Navigation arrows -->
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
    </div>
  </div>
</section>

<script>
  import Swiper from 'swiper'
  import { Autoplay, Navigation } from 'swiper/modules'

  function initTestimonialsSwiper() {
    // Destroy existing swiper if it exists
    const swiperElement = document.querySelector('.testimonials .swiper') as any
    if (swiperElement?.swiper) {
      swiperElement.swiper.destroy(true, true)
    }

    // Initialize Swiper with required modules
    const swiper = new Swiper('.testimonials .swiper', {
      modules: [Autoplay, Navigation],
      loop: true,
      autoplay: {
        delay: 5000,
        disableOnInteraction: false,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      slidesPerView: 1,
      spaceBetween: 20,
      breakpoints: {
        768: {
          slidesPerView: 2,
          spaceBetween: 30,
        },
        1024: {
          slidesPerView: 3,
          spaceBetween: 40,
        },
      },
    })

    // Add click event listener to each slide
    document.querySelectorAll('.testimonials .swiper-slide').forEach((slide, index) => {
      slide.addEventListener('click', () => {
        // Check if it's the last slide
        if (index === swiper.slides.length - 1) {
          swiper.slideTo(0) // Go to the first slide
        } else {
          swiper.slideTo(index + 1) // Go to the next slide
        }
      })
    })
  }

  // Initialize on DOM ready and also on page transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTestimonialsSwiper)
  } else {
    initTestimonialsSwiper()
  }

  // Reinitialize on view transitions (for modern navigation)
  document.addEventListener('astro:page-load', initTestimonialsSwiper)
</script>